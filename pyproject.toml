# ========================================================
# [project] METADATOS de tu proyecto Python
# Project metadata block
# Define general info for packaging, publishing, and documentation tools.
# ========================================================
[project]
name = "demo"  # Nombre del proyecto / Project name
version = "0.1.0"  # Versi√≥n inicial / Initial version
description = "Demo sobre pruebas unitarias"  # Breve descripci√≥n / Short description
readme = "README.md"  # Archivo README incluido / Main README file
requires-python = ">=3.9"  # Versi√≥n m√≠nima de Python requerida / Minimum Python version required
authors = [
    { name = "Ismael Sanroman", email = "ismaelsanromansanchez@gmail.com" }  # Autor y email
]
dependencies = []  # Dependencias necesarias para funcionar / Dependencies (empty here)
classifiers = [
    "Programming Language :: Python :: 3.9",  # Compatible con Python 3.9
    "Operating System :: OS Independent"       # Sistema operativo indiferente
]

[project.urls]
"Source" = "https://github.com/ismaelsanroman/UnitTest_demo"  # Enlace al repo

# ---------------------------------------------
# SETUPTOOLS
# Define c√≥mo y d√≥nde buscar los paquetes a incluir en el build
# ---------------------------------------------
[tool.setuptools.packages.find]
where = ["src"]      # Carpeta ra√≠z donde buscar m√≥dulos
include = ["pokemon"]  # S√≥lo incluye el paquete 'pokemon'

# ========================================================
# Configuraci√≥n de RUFF
# Linter y formateador ultrarr√°pido para Python
# https://docs.astral.sh/ruff/
# ========================================================
[tool.ruff]
exclude = [
    # Lista de carpetas y archivos a ignorar
    ".bzr", ".direnv", ".eggs", ".git", ".git-rewrite", ".hg", ".ipynb_checkpoints",
    ".mypy_cache", ".nox", ".pants.d", ".pyenv", ".pytest_cache", ".pytype",
    ".ruff_cache", ".svn", ".tox", ".venv", ".vscode", "__pypackages__", "_build",
    "buck-out", "build", "dist", "node_modules", "site-packages", "venv", "docs",
    "gunicorn_config.py", "src/utils/helpers/azure/sharepoint.py"
]
line-length = 100      # Longitud m√°xima de l√≠nea
indent-width = 4       # Espacios de indentaci√≥n
target-version = "py310"  # Apunta a Python 3.10 para el an√°lisis

[tool.ruff.lint]
select = [
    # üîç Activamos familias de reglas espec√≠ficas para analizar el c√≥digo.
    # Estas cubren desde estilo, errores comunes, seguridad, hasta buenas pr√°cticas modernas.

    "A",     # Builtins: evita redefinir funciones internas como `list`, `str`, `open`, etc.
    "B",     # Bugbear: detecta errores sutiles y malas pr√°cticas comunes en Python.
    "C",     # Complejidad (McCabe): controla funciones con demasiadas bifurcaciones l√≥gicas.
    "D",     # Docstrings: fuerza a documentar clases, funciones y m√≥dulos correctamente.
    "E",     # Pycodestyle (errores): reglas cl√°sicas de estilo (espaciado, indentaci√≥n...).
    "F",     # Pyflakes: detecta c√≥digo muerto, variables no usadas o mal referenciadas.
    "I",     # Isort: organiza y agrupa los `import` seg√∫n convenci√≥n.
    "N",     # Naming (PEP8): asegura que nombres sigan las convenciones (snake_case, CamelCase...).
    "S",     # Seguridad (Bandit): analiza vulnerabilidades comunes (eval, subprocess inseguro...).
    "T",     # Print: proh√≠be `print()` en c√≥digo de producci√≥n (mejor usar logging).
    "Q",     # ‚ùù Comillas: unifica uso de comillas simples o dobles seg√∫n configuraci√≥n.
    "W",     # Pycodestyle (warnings): advertencias leves pero √∫tiles para mantener calidad.
    "ANN",   # Anotaciones de tipo: requiere `type hints` en funciones, clases, par√°metros...
    "COM",   # Comas: controla estilo de comas en listas, diccionarios y tuplas multilinea.
    "TRY",   # Try/Except: buenas pr√°cticas en manejo de excepciones (por ejemplo, evitar `except:`).
    "PTH",   # Pathlib: fomenta el uso de `pathlib.Path` en vez de `os.path` (m√°s moderno y robusto).
    "RET",   # Return: coherencia en `return` (por ejemplo, no devolver algo en unas ramas y `None` en otras).
    "TD",    # TODOs: detecta comentarios `TO.DO` como tareas pendientes visibles.
    "ERA",   # C√≥digo muerto: detecta c√≥digo comentado o inalcanzable que debe eliminarse.
    "PT"     # Pytest: asegura buenas pr√°cticas espec√≠ficas de `pytest` (fixtures, asserts, etc.).
]
ignore = [
    # Reglas ignoradas por motivos pr√°cticos o de estilo
    "E203", "F403",                         # Por compatibilidad con black, imports con '*'
    "ANN101", "ANN102", "ANN204", "ANN401", # Type hints no requeridos en todos los casos
    "D100", "D104", "D202", "D203",         # Docstring flexibilidad
    "TRY400",                               # Excepciones
    "PTH123",                               # Pathlib opcional
    "COM812"                                # Comas al final de lista (estilo black)
]
fixable = ["ALL"]       # Permite autocorrecciones de to.do tipo
unfixable = []          # Nada marcado como no autocorregible
dummy-variable-rgx = "^(_|(__[a-zA-Z0-9_]+__[a-zA-Z0-9_]*))$" # Variables dummy (ej: _)

[tool.ruff.lint.per-file-ignores]
"tests/**/*.py" = [
    # En tests se ignoran algunas reglas para mayor flexibilidad
    "S101",                             # assert statements permitidos
    "D101", "D102", "D103",             # docstrings en clases y m√©todos de test no requeridos
    "ANN001", "ANN002", "ANN003", "ANN201" # type annotations menos estrictas
]

[tool.ruff.format]
quote-style = "double"              # Comillas dobles por defecto
indent-style = "space"              # Indentaci√≥n por espacios
skip-magic-trailing-comma = false   # Mantener comas m√°gicas
line-ending = "auto"                # Final de l√≠nea autom√°tico
docstring-code-format = true        # Formatea el c√≥digo dentro de docstrings
docstring-code-line-length = "dynamic"  # Longitud de l√≠nea en docstring ajustable

[tool.ruff.lint.isort]
split-on-trailing-comma = true      # Separar imports con coma final
force-wrap-aliases = true           # Forzar wrap de alias de imports
combine-as-imports = true           # Combina imports con 'as'

[tool.ruff.lint.mccabe]
max-complexity = 10                 # Complejidad ciclom√°tica m√°xima por funci√≥n

[tool.ruff.lint.pydocstyle]
convention = "numpy"                # Formato de docstrings estilo numpy
max-doc-length = 120                # Docstring m√°ximo de 120 caracteres

[tool.ruff.lint.flake8-bandit]
check-typed-exception = true        # Verifica excepciones tipadas para seguridad

[tool.ruff.lint.flake8-bugbear]
extend-immutable-calls = [
    # Extiende an√°lisis a decoradores de FastAPI
    "fastapi.Depends", "fastapi.params.Depends",
    "fastapi.Query", "fastapi.params.Query"
]

# ========================================================
# Pytest - Configuraci√≥n del runner de tests
# ========================================================
[tool.pytest.ini_options]
minversion = "7.0"          # Versi√≥n m√≠nima recomendada de pytest
testpaths = ["tests"]       # Carpeta donde buscar tests
pythonpath = ["src"]        # A√±ade src al PYTHONPATH
addopts = """
  -ra
  --strict-markers
  --cov=src
  --cov-report=term-missing
  --cov-report=html
""" # Opciones por defecto: resumen, cobertura estricta y reportes
markers = [
    # Marcadores personalizados para clasificar tests
    "unit: Unit tests r√°pidos.",
    "integration: Integration tests lentos.",
    "e2e: End-to-End tests completos.",
    "pokemon: Tests relacionados con Pok√©mon.",
    "create: Test de creaci√≥n",
    "battle: Test batallas pokemon",
    "happy_path: Test que marca el camino correcto",
    "unhappy_path: Test que marca el camino incorrecto",
    "functional: Functional tests.",
    "exception_handling: Tests de excepciones.",
    "ports: Tests de puertos.",
    "agents: Tests de agentes.",
    "utils: Tests de utilidades.",
    "process: Tests de procesos.",
    "performance: Tests de rendimiento.",
    "regression: Tests de regresi√≥n.",
    "smoke: Smoke tests.",
    "slow: Tests lentos.",
    "db: Tests de base de datos."
]

# ========================================================
# Coverage - Cobertura de c√≥digo
# https://coverage.readthedocs.io/
# ========================================================
[tool.coverage.run]
branch = true              # Medici√≥n de cobertura por ramas (mayor precisi√≥n)
source = ["src"]           # Solo mide cobertura sobre src

[tool.coverage.report]
show_missing = true        # Muestra l√≠neas no cubiertas en el reporte
fail_under = 80            # Falla si la cobertura baja del 80%

# ========================================================
# Cosmic Ray - Mutation Testing
# https://cosmic-ray.readthedocs.io/
# ========================================================
[tool.cosmic-ray]
module-path = "src"                # Carpeta de c√≥digo a mutar
timeout = 30                       # Tiempo m√°ximo de test por mutaci√≥n (seg)
exclude-modules = ["tests/*"]      # No muta los tests
test-runner = "cosmic_ray.testing.pytest.runner" # Usa pytest como runner
baseline = 80                      # Exige m√≠nimo 80% de supervivencia mutante

# ========================================================
# Hypothesis - Property based testing
# https://hypothesis.readthedocs.io/
# ========================================================
[tool.hypothesis]
deadline = 500           # M√°ximo 500ms por test
max_examples = 100       # M√°ximo 100 ejemplos generados por test
report_multiple_bugs = true  # Reporta todos los fallos en vez de parar en el primero

# ========================================================
# Xenon - Complejidad ciclom√°tica
# https://xenon.readthedocs.io/
# ========================================================
[tool.xenon]
max-absolute = "B"     # Nota m√°xima permitida para funci√≥n/m√≥dulo/paquete ('A' es mejor que 'B')
max-modules = "B"
max-average = "B"
exclude = ["tests/*"]  # No analiza tests

# ========================================================
# Pipenv scripts - Scripts personalizados con Pipenv
# Ejecutables f√°cilmente desde 'pipenv run <nombre>'
# ========================================================
[tool.pipenv.scripts]
test = "pytest"                                        # Ejecuta los tests
lint = "ruff check src"                                # Linter Ruff en src
format = "ruff format src"                             # Formateador Ruff en src
spell = "codespell --ignore-words .codespell.ignorewords --skip=.venv" # Correcci√≥n ortogr√°fica
xenon = "python -m xenon --max-absolute B --max-modules B --max-average B ./src" # Chequea complejidad
mutate = "cosmic-ray init config.toml cr_session.sqlite --force && pipenv run cosmic-ray exec config.toml cr_session.sqlite && pipenv run cosmic-ray dump cr_session.sqlite > mutation-testing-report.json"
# Pipeline de mutation testing: inicializa, ejecuta, y exporta a JSON

# ========================================================
# Build System - Configuraci√≥n del sistema de build
# ========================================================
[build-system]
requires = ["setuptools>=61.0"]  # setuptools moderno requerido
build-backend = "setuptools.build_meta"  # Backend est√°ndar para build

